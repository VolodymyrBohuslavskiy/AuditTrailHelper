<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <title>Salesforce audit log viewer</title>
</head>
<body>

<div class="m-3">
    <h2>Salesforce audit log viewer</h2>
    <input type="file" id="csvFile" accept=".csv">

    <label for="user-select">
        User:
        <select name="user" id="user-select">
            <option>All</option>
        </select>
    </label>

    <label for="section-select">
        Section:
        <select name="section" id="section-select">
            <option>All</option>
        </select>
    </label>

</div>

<table class="table table-bordered">
    <thead>
    <tr>
        <th></th>
        <th>#</th>
        <th>Date</th>
        <th>User</th>
        <th>Section</th>
        <th>Action</th>
    </tr>
    </thead>
    <tbody id="tableBody">
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js">
</script>

<script>
  let csvFileResponseOriginal;
  let csvFileResponseResult;

  let users = new Set();
  let selectedUser;
  let sections = new Set();
  let selectedSection;

  document.addEventListener('DOMContentLoaded', () => {
    const csvFile = document.getElementById('csvFile');

    csvFile.addEventListener('change', () => {
      const file = csvFile.files[0];
      const reader = new FileReader();

      reader.onload = (e) => csvFileResponseOriginal = parseCSV(e.target.result);
      reader.readAsText(file);
      reader.onloadend = () => populateValues();
    });

    function populateValues () {
      csvFileResponseOriginal.forEach((log, index) => {
          log.Id = ++index;
          log.DateFormated = moment(log.Date).format('DD/MMMM/YYYY - HH:mm');
          log.DateValue = moment(log.Date).format('l');

          if (log?.User.includes("@")) {
            users.add(log?.User);
          }

          sections.add(log?.Section);
        }
      )

      publishContent();
    }
  })

  document.getElementById('user-select').addEventListener('change', (event) => {
    document.getElementById('section-select').value = 'All';
    selectedUser = event.target.value;
    if (selectedUser === 'All') {
      renderTableBody();
      return;
    }

    renderTableBody(csvFileResponseOriginal.filter(log => log.User === selectedUser));
  });


  document.getElementById('section-select').addEventListener('change', (event) => {
    document.getElementById('user-select').value = 'All';
    selectedSection = event.target.value;
    if (selectedSection === 'All') {
      renderTableBody();
      return;
    }
    renderTableBody(csvFileResponseOriginal.filter(log => log.Section === selectedSection));
  });

  function renderTableBody (listOfLogs) {
    listOfLogs = listOfLogs || csvFileResponseOriginal;

    let tableBody = '';
    listOfLogs.forEach((log) => {
      tableBody += `<tr><td><input class="form-check-input" type="checkbox" id="check${log.Id}"></td><td>${log.Id}</td><td>${log?.DateFormated}</td><td>${log?.User}</td><td class="overflow-auto w-25">${log?.Section}</td><td class="overflow-auto w-25">${log?.Action}</td></tr>`;
    });

    document.getElementById('tableBody').innerHTML = tableBody;
  }

  function publishContent () {
    renderTableBody();

    users.forEach((user) => {
      document.getElementById('user-select').innerHTML += `<option value="${user}">${user}</option>`;
    });

    sections.forEach((section) => {

      if (section.length > 2) {
        document.getElementById('section-select').innerHTML += `<option value="${section}">${section.length > 30 ? section.substring(0, 26) + '...' : section}</option>`;
      }
    });
  }

  function parseCSV (csvString) {
    const lines = csvString.trim().split('\n');
    if (lines.length === 0) {
      return [];
    }

    if (lines[lines.length - 1].trim() === '') {
      lines.pop();
    }

    const headers = lines[0].split(',').map(header => header.trim());
    const result = [];

    for (let i = 1; i < lines.length; i++) {
      const currentLine = lines[i].split(',');
      const obj = {};
      for (let j = 0; j < headers.length; j++) {
        let value = currentLine[j] ? currentLine[j].trim() : '';
        if (value.startsWith('"') && value.endsWith('"')) {
          value = value.substring(1, value.length - 1);
        }
        obj[headers[j]] = value;
      }
      result.push(obj);
    }
    return result;
  }
</script>

</body>
</html>